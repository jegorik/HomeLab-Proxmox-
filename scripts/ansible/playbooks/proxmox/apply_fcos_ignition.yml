# ==============================================================================
# Ansible Playbook: Apply Fedora CoreOS Ignition Configuration
# ==============================================================================
#
# This playbook is the SECOND STAGE of Fedora CoreOS VM deployment.
# It applies Ignition configuration via qm command and starts the VM.
#
# NON-INTERACTIVE: Designed for CI/CD pipelines and Semaphore UI.
# No user prompts - runs to completion or fails with error.
#
# PREREQUISITES:
# 1. VM must be created by OpenTofu (terraform/fedora_core)
# 2. Ansible user must have sudo access on Proxmox host
# 3. Variables file generated by OpenTofu must be provided
#
# USAGE (CLI):
#   ansible-playbook -i inventory.yml apply_fcos_ignition.yml \
#     -e @../../terraform/fedora_core/generated/<vm_name>-ansible-vars.yml
#
# USAGE (Semaphore UI):
#   Configure Task with Extra CLI Arguments:
#     -e @terraform/fedora_core/generated/<vm_name>-ansible-vars.yml
#
# REQUIRED VARIABLES:
#   - vm_id: Proxmox VM ID (e.g., 101)
#   - proxmox_node: Proxmox node name (e.g., pve)
#   - ignition_config_escaped: Escaped Ignition JSON (commas as ,,)
#
# OPTIONAL VARIABLES:
#   - start_vm_after_ignition: Start VM after config (default: true)
#   - wait_for_ssh: Wait for SSH access (default: true)
#   - ssh_timeout: SSH timeout in seconds (default: 300)
#   - vm_ip_address: VM IP for SSH check (default: dhcp)
#
# Author: jegorik
# Last Updated: December 2025
# ==============================================================================
---
- name: Apply Fedora CoreOS Ignition Configuration
  hosts: proxmox
  become: true
  gather_facts: false

  vars:
    # Default values (override with -e or vars file)
    start_vm_after_ignition: true
    wait_for_ssh: true
    ssh_timeout: 300
    ssh_user: "core"
    vm_ip_address: "dhcp"

  pre_tasks:
    # --------------------------------------------------------------------------
    # Validation
    # --------------------------------------------------------------------------
    - name: Validate required variables
      ansible.builtin.fail:
        msg: "Required variable '{{ item }}' is not defined"
      when: vars[item] is not defined
      loop:
        - vm_id
        - proxmox_node
        - ignition_config_escaped

    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          Deploying Fedora CoreOS Ignition:
            VM ID: {{ vm_id }}
            VM Name: {{ vm_name | default('N/A') }}
            Node: {{ proxmox_node }}
            Start after config: {{ start_vm_after_ignition }}
            Wait for SSH: {{ wait_for_ssh }}
            IP Address: {{ vm_ip_address }}

  tasks:
    # --------------------------------------------------------------------------
    # Check VM Status
    # --------------------------------------------------------------------------
    - name: Check if VM exists
      ansible.builtin.command:
        cmd: qm status {{ vm_id }}
      register: vm_status
      changed_when: false
      failed_when: vm_status.rc != 0

    - name: Display current VM status
      ansible.builtin.debug:
        msg: "VM {{ vm_id }} status: {{ vm_status.stdout }}"

    - name: Ensure VM is stopped before applying Ignition
      ansible.builtin.command:
        cmd: qm stop {{ vm_id }}
      when: "'running' in vm_status.stdout"
      register: vm_stop_result
      changed_when: vm_stop_result.rc == 0

    - name: Wait for VM to stop
      ansible.builtin.command:
        cmd: qm status {{ vm_id }}
      register: vm_status_check
      until: "'stopped' in vm_status_check.stdout"
      retries: 30
      delay: 2
      changed_when: false
      when: "'running' in vm_status.stdout"

    # --------------------------------------------------------------------------
    # Apply Ignition Configuration
    # --------------------------------------------------------------------------
    - name: Apply Ignition configuration via qm set args
      ansible.builtin.command:
        cmd: >
          qm set {{ vm_id }}
          -args "-fw_cfg 'name=opt/com.coreos/config,string={{ ignition_config_escaped }}'"
      register: ignition_apply_result
      changed_when: ignition_apply_result.rc == 0

    - name: Verify Ignition args applied
      ansible.builtin.command:
        cmd: qm config {{ vm_id }}
      register: vm_config
      changed_when: false

    - name: Check if args were applied
      ansible.builtin.assert:
        that:
          - "'args:' in vm_config.stdout"
          - "'fw_cfg' in vm_config.stdout"
        fail_msg: "Failed to apply Ignition configuration"
        success_msg: "Ignition configuration applied successfully"

    # --------------------------------------------------------------------------
    # Start VM
    # --------------------------------------------------------------------------
    - name: Start VM with Ignition configuration
      ansible.builtin.command:
        cmd: qm start {{ vm_id }}
      register: vm_start_result
      changed_when: vm_start_result.rc == 0
      when: start_vm_after_ignition | bool

    - name: Wait for VM to start
      ansible.builtin.command:
        cmd: qm status {{ vm_id }}
      register: vm_running_check
      until: "'running' in vm_running_check.stdout"
      retries: 30
      delay: 2
      changed_when: false
      when: start_vm_after_ignition | bool

    # --------------------------------------------------------------------------
    # Wait for Ignition to Complete
    # --------------------------------------------------------------------------
    - name: Display Ignition boot notice
      ansible.builtin.debug:
        msg: |
          VM {{ vm_id }} is now booting with Ignition configuration.
          Fedora CoreOS will:
          1. Apply Ignition config on first boot
          2. Install qemu-guest-agent via rpm-ostree (if enabled)
          3. Reboot automatically to apply rpm-ostree changes
          This process takes approximately 2-5 minutes.
      when: start_vm_after_ignition | bool

    - name: Wait for initial boot and potential reboot (qemu-guest-agent install)
      ansible.builtin.wait_for:
        timeout: 120
      when: 
        - start_vm_after_ignition | bool
        - wait_for_ssh | bool

    # --------------------------------------------------------------------------
    # Verify SSH Access
    # --------------------------------------------------------------------------
    - name: Wait for SSH to become available
      ansible.builtin.wait_for:
        host: "{{ vm_ip_address }}"
        port: 22
        timeout: "{{ ssh_timeout }}"
        state: started
      delegate_to: localhost
      become: false
      when:
        - start_vm_after_ignition | bool
        - wait_for_ssh | bool
        - vm_ip_address != "dhcp"

    - name: Display DHCP notice
      ansible.builtin.debug:
        msg: |
          VM is using DHCP - Cannot verify SSH automatically.
          Check Proxmox UI for the assigned IP address, or use:
            qm guest cmd {{ vm_id }} network-get-interfaces
          Then connect with: ssh {{ ssh_user }}@<ip_address>
      when:
        - start_vm_after_ignition | bool
        - vm_ip_address == "dhcp"

  post_tasks:
    # --------------------------------------------------------------------------
    # Final Status
    # --------------------------------------------------------------------------
    - name: Get final VM status
      ansible.builtin.command:
        cmd: qm status {{ vm_id }}
      register: final_status
      changed_when: false

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          FEDORA COREOS DEPLOYMENT COMPLETE
          =================================
          VM ID: {{ vm_id }}
          Name:  {{ vm_name | default('N/A') }}
          Status: {{ final_status.stdout }}
          {% if vm_ip_address != "dhcp" %}
          IP: {{ vm_ip_address }}
          SSH: ssh {{ ssh_user }}@{{ vm_ip_address }}
          {% endif %}

# ==============================================================================
# END OF PLAYBOOK
# ==============================================================================
