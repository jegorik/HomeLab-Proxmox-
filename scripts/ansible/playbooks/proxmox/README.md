# Proxmox Host Management Playbooks

Playbooks for managing Proxmox VE hypervisor and VM/container operations.

## ğŸ“‹ Available Playbooks

### apply_fcos_ignition.yml

**Purpose**: Apply Ignition configuration to Fedora CoreOS VMs created by OpenTofu.

**Use Case**: Second stage of Fedora CoreOS deployment (after `tofu apply`).

**Mode**: Non-interactive (CI/CD compatible, Semaphore UI ready)

**Requirements**:

- VM must exist (created by OpenTofu)
- Ansible user with sudo access on Proxmox host
- Variables file generated by OpenTofu (`generated/<vm_name>-ansible-vars.yml`)

**Usage (CLI)**:

```bash
# With variables file from OpenTofu
ansible-playbook -i inventory.yml apply_fcos_ignition.yml \
  -e @../../terraform/fedora_core/generated/<vm_name>-ansible-vars.yml
```

**Usage (Semaphore UI)**:

1. Create Ansible Task
2. Set Playbook: `scripts/ansible/playbooks/proxmox/apply_fcos_ignition.yml`
3. Set Extra CLI Arguments: `-e @terraform/fedora_core/generated/<vm_name>-ansible-vars.yml`
4. Run Task (no user input required)

**Variables**:

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `vm_id` | âœ… | - | Proxmox VM ID |
| `proxmox_node` | âœ… | - | Proxmox node name |
| `ignition_config_escaped` | âœ… | - | Escaped Ignition JSON (commas as `,,`) |
| `vm_name` | âŒ | - | VM name for logging |
| `start_vm_after_ignition` | âŒ | `true` | Start VM after config |
| `wait_for_ssh` | âŒ | `true` | Wait for SSH access |
| `ssh_timeout` | âŒ | `300` | SSH timeout in seconds |
| `vm_ip_address` | âŒ | `dhcp` | VM IP for SSH verification |

**Workflow**:

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Validate vars  â”‚â”€â”€â”€â”€â–¶â”‚  Stop VM if     â”‚â”€â”€â”€â”€â–¶â”‚  qm set -args   â”‚
â”‚  (vm_id, etc.)  â”‚     â”‚  running        â”‚     â”‚  (fw_cfg)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Report status  â”‚â—€â”€â”€â”€â”€â”‚  Wait for SSH   â”‚â—€â”€â”€â”€â”€â”‚  qm start VM    â”‚
â”‚  (success/fail) â”‚     â”‚  (if enabled)   â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Exit Codes**:

- `0` - Success: Ignition applied and VM started
- `non-zero` - Failure: Check Ansible output for details

## ğŸ”§ Adding New Proxmox Playbooks

When adding new playbooks to this category:

1. Focus on Proxmox host operations (`qm`, `pct`, `pvesh` commands)
2. Use `become: true` for privileged operations
3. Target `hosts: proxmox` group
4. Document required variables in playbook header
5. **Keep non-interactive** for CI/CD compatibility (no `vars_prompt` or `pause` with prompts)

## ğŸ“š Related Resources

- [Proxmox VE Admin Guide](https://pve.proxmox.com/wiki/Main_Page)
- [qm Command Reference](https://pve.proxmox.com/pve-docs/qm.1.html)
- [Fedora CoreOS Ignition](https://docs.fedoraproject.org/en-US/fedora-coreos/producing-ign/)
- [Semaphore UI Documentation](https://docs.semaphoreui.com/)
